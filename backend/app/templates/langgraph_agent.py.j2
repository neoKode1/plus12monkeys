"""{{ project_name }} â€” {{ template_name }}

{{ template_description }}

Generated by +12 Monkeys â€¢ Framework: LangGraph
"""

import os
import operator
from typing import Annotated, Any, Dict, List, TypedDict

from dotenv import load_dotenv
from langchain_anthropic import ChatAnthropic
from langgraph.graph import END, StateGraph

load_dotenv()

# ---------------------------------------------------------------------------
# State
# ---------------------------------------------------------------------------
class AgentState(TypedDict):
    input: str
    {% for agent in agents %}
    {{ agent.role }}_output: Annotated[str, operator.add]
    {% endfor %}
    final_output: str


# ---------------------------------------------------------------------------
# LLM
# ---------------------------------------------------------------------------
llm = ChatAnthropic(
    model=os.getenv("LLM_MODEL", "claude-sonnet-4-20250514"),
    anthropic_api_key=os.getenv("ANTHROPIC_API_KEY"),
)

{% for agent in agents %}
# ---------------------------------------------------------------------------
# Node: {{ agent.role }}
# ---------------------------------------------------------------------------
def {{ agent.role }}_node(state: AgentState) -> Dict[str, Any]:
    """{{ agent.goal }}"""
    prompt = (
        f"You are the {{ agent.role }} agent. Your goal: {{ agent.goal }}\n\n"
{% if agent.guidelines %}
        # Agent guidelines (generated from +12 Monkeys prompt patterns)
        """{{ agent.guidelines }}"""
        "\n\n"
{% endif %}
        f"Input: {state.get('input', '')}\n"
        {% if not loop.first %}
        {% set prev = agents[loop.index0 - 1] %}
        f"Previous step output: {state.get('{{ prev.role }}_output', '')}\n"
        {% endif %}
        "Provide your output:"
    )
    response = llm.invoke(prompt)
    return {"{{ agent.role }}_output": response.content}

{% endfor %}

# ---------------------------------------------------------------------------
# Graph
# ---------------------------------------------------------------------------
workflow = StateGraph(AgentState)

{% for agent in agents %}
workflow.add_node("{{ agent.role }}", {{ agent.role }}_node)
{% endfor %}

# Linear pipeline: entry â†’ agent1 â†’ agent2 â†’ ... â†’ END
workflow.set_entry_point("{{ agents[0].role }}")
{% for agent in agents %}
{% if not loop.last %}
workflow.add_edge("{{ agent.role }}", "{{ agents[loop.index0 + 1].role }}")
{% else %}
workflow.add_edge("{{ agent.role }}", END)
{% endif %}
{% endfor %}

app = workflow.compile()


# ---------------------------------------------------------------------------
# Entry Point
# ---------------------------------------------------------------------------
def main():
    import sys
    user_input = " ".join(sys.argv[1:]) if len(sys.argv) > 1 else "Hello, I need help."
    print(f"\nğŸš€ Starting {{ project_name }} pipeline...\n")
    result = app.invoke({"input": user_input})
    last_key = "{{ agents[-1].role }}_output"
    print(f"\nâœ… Result:\n{result.get(last_key, result)}")


if __name__ == "__main__":
    main()

